{% extends "document.njk" %}

{% block content %}
<style>
  .br-form {
    max-width: 600px;
  }

  .br-field {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xs, 0.25rem);
    margin-block-end: var(--space-m, 1rem);
  }

  .br-field label {
    font: var(--font-label, bold 0.875rem/1.4 sans-serif);
  }

  .br-field-hint {
    color: var(--color-on-offset, #666);
    font: var(--font-caption, 0.875rem/1.4 sans-serif);
  }

  .br-field input,
  .br-field select,
  .br-field textarea {
    appearance: none;
    background-color: var(--color-background, #fff);
    border: 1px solid var(--color-outline-variant, #ccc);
    border-radius: var(--border-radius-small, 0.25rem);
    font: var(--font-body, 0.875rem/1.4 sans-serif);
    padding: calc(var(--space-s, 0.75rem) / 2) var(--space-s, 0.75rem);
    width: 100%;
  }

  .br-field textarea {
    min-height: 100px;
  }

  .br-field input:focus,
  .br-field select:focus,
  .br-field textarea:focus {
    border-color: var(--color-primary, #0066cc);
    outline: 2px solid var(--color-primary, #0066cc);
    outline-offset: 1px;
  }

  .br-field-inline {
    flex-direction: row;
    align-items: center;
    gap: var(--space-s, 0.75rem);
  }

  .br-field-inline input[type="checkbox"] {
    appearance: auto;
    width: auto;
    cursor: pointer;
  }

  .br-section {
    margin-block-start: var(--space-l, 1.5rem);
    padding-block-start: var(--space-l, 1.5rem);
    border-block-start: 1px solid var(--color-outline-variant, #ddd);
  }

  .br-section h3 {
    font: var(--font-subhead, bold 1rem/1.4 sans-serif);
    margin-block-end: var(--space-s, 0.75rem);
  }

  .br-items-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs, 0.5rem);
  }

  .br-item {
    background: var(--color-offset, #f5f5f5);
    border-radius: var(--border-radius-small, 0.25rem);
    padding: var(--space-xs, 0.5rem) var(--space-s, 0.75rem);
  }

  .br-item-title {
    font: var(--font-body, 0.875rem/1.4 sans-serif);
    font-weight: 600;
  }

  .br-item-title a {
    color: inherit;
    text-decoration: none;
  }

  .br-item-title a:hover {
    text-decoration: underline;
  }

  .br-item-meta {
    color: var(--color-on-offset, #666);
    font: var(--font-caption, 0.75rem/1.4 sans-serif);
  }

  .br-empty {
    color: var(--color-on-offset, #666);
    font: var(--font-caption, 0.875rem/1.4 sans-serif);
    text-align: center;
    padding: var(--space-m, 1rem);
  }

  .br-discover-section {
    background: var(--color-offset, #f5f5f5);
    border-radius: var(--border-radius-small, 0.5rem);
    padding: var(--space-m, 1rem);
    margin-block-end: var(--space-m, 1rem);
  }

  .br-discover-section .br-field {
    margin-block-end: var(--space-s, 0.75rem);
  }

  .br-discover-input {
    display: flex;
    gap: var(--space-s, 0.75rem);
  }

  .br-discover-input input {
    flex: 1;
    appearance: none;
    background-color: var(--color-background, #fff);
    border: 1px solid var(--color-outline-variant, #ccc);
    border-radius: var(--border-radius-small, 0.25rem);
    font: var(--font-body, 0.875rem/1.4 sans-serif);
    padding: calc(var(--space-s, 0.75rem) / 2) var(--space-s, 0.75rem);
  }

  .br-discover-result {
    margin-block-start: var(--space-s, 0.75rem);
    padding: var(--space-s, 0.75rem);
    background: var(--color-background, #fff);
    border-radius: var(--border-radius-small, 0.25rem);
    font: var(--font-caption, 0.875rem/1.4 sans-serif);
  }

  .br-discover-result.br-discover-result--error {
    color: var(--color-error, #dc3545);
  }

  .br-discover-result.br-discover-result--success {
    color: var(--color-success, #28a745);
  }

  .br-discover-feeds {
    list-style: none;
    padding: 0;
    margin: var(--space-xs, 0.5rem) 0 0 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs, 0.5rem);
  }

  .br-discover-feed {
    display: flex;
    align-items: center;
    gap: var(--space-s, 0.75rem);
    padding: var(--space-xs, 0.5rem);
    background: var(--color-offset, #f5f5f5);
    border-radius: var(--border-radius-small, 0.25rem);
    cursor: pointer;
  }

  .br-discover-feed:hover {
    background: var(--color-primary-offset, #e6f0ff);
  }

  .br-discover-feed-url {
    flex: 1;
    font-family: monospace;
    font-size: 0.75rem;
    word-break: break-all;
  }

  .br-discover-feed-type {
    background: var(--color-primary, #0066cc);
    color: white;
    padding: 0.125rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.625rem;
    text-transform: uppercase;
  }

  .br-divider {
    border: none;
    border-block-start: 1px solid var(--color-outline-variant, #ddd);
    margin: var(--space-m, 1rem) 0;
  }
</style>

<header class="page-header">
  <a href="{{ baseUrl }}/blogs" class="page-header__back">{{ icon("previous") }} {{ __("blogroll.blogs.title") }}</a>
  <h1 class="page-header__title">{{ title }}</h1>
</header>

{% for message in request.session.messages %}
<div class="notice notice--{{ message.type }}">
  <p>{{ message.content }}</p>
</div>
{% endfor %}

<form method="post" action="{% if isNew %}{{ baseUrl }}/blogs{% else %}{{ baseUrl }}/blogs/{{ blog._id }}{% endif %}" class="br-form">
  {% if isNew %}
  <div class="br-discover-section">
    <div class="br-field">
      <label for="discoverUrl">{{ __("blogroll.blogs.form.discoverUrl") }}</label>
      <div class="br-discover-input">
        <input type="url" id="discoverUrl" placeholder="https://tantek.com">
        <button type="button" id="discoverBtn" class="button button--secondary">
          {{ __("blogroll.blogs.form.discover") }}
        </button>
      </div>
      <span class="br-field-hint">{{ __("blogroll.blogs.form.discoverHint") }}</span>
    </div>
    <div id="discoverResult" class="br-discover-result" style="display: none;"></div>
  </div>
  <hr class="br-divider">
  {% endif %}

  <div class="br-field">
    <label for="feedUrl">{{ __("blogroll.blogs.form.feedUrl") }}</label>
    <input type="url" id="feedUrl" name="feedUrl" value="{{ blog.feedUrl if blog else '' }}" required placeholder="https://example.com/feed.xml">
    <span class="br-field-hint">{{ __("blogroll.blogs.form.feedUrlHint") }}</span>
  </div>

  <div class="br-field">
    <label for="title">{{ __("blogroll.blogs.form.title") }}</label>
    <input type="text" id="title" name="title" value="{{ blog.title if blog else '' }}" placeholder="{{ __('blogroll.blogs.form.titlePlaceholder') }}">
    <span class="br-field-hint">{{ __("blogroll.blogs.form.titleHint") }}</span>
  </div>

  <div class="br-field">
    <label for="siteUrl">{{ __("blogroll.blogs.form.siteUrl") }}</label>
    <input type="url" id="siteUrl" name="siteUrl" value="{{ blog.siteUrl if blog else '' }}" placeholder="https://example.com">
    <span class="br-field-hint">{{ __("blogroll.blogs.form.siteUrlHint") }}</span>
  </div>

  <div class="br-field">
    <label for="category">{{ __("blogroll.blogs.form.category") }}</label>
    <input type="text" id="category" name="category" value="{{ blog.category if blog else '' }}" placeholder="Technology">
    <span class="br-field-hint">{{ __("blogroll.blogs.form.categoryHint") }}</span>
  </div>

  <div class="br-field">
    <label for="tags">{{ __("blogroll.blogs.form.tags") }}</label>
    <input type="text" id="tags" name="tags" value="{{ blog.tags | join(', ') if blog and blog.tags else '' }}" placeholder="indie, personal, tech">
    <span class="br-field-hint">{{ __("blogroll.blogs.form.tagsHint") }}</span>
  </div>

  <div class="br-field">
    <label for="notes">{{ __("blogroll.blogs.form.notes") }}</label>
    <textarea id="notes" name="notes" placeholder="{{ __('blogroll.blogs.form.notesPlaceholder') }}">{{ blog.notes if blog else '' }}</textarea>
    <span class="br-field-hint">{{ __("blogroll.blogs.form.notesHint") }}</span>
  </div>

  <div class="br-field br-field-inline">
    <input type="checkbox" id="pinned" name="pinned" {% if blog and blog.pinned %}checked{% endif %}>
    <label for="pinned">{{ __("blogroll.blogs.form.pinned") }}</label>
  </div>

  <div class="br-field br-field-inline">
    <input type="checkbox" id="hidden" name="hidden" {% if blog and blog.hidden %}checked{% endif %}>
    <label for="hidden">{{ __("blogroll.blogs.form.hidden") }}</label>
  </div>

  <div class="button-group">
    <button type="submit" class="button button--primary">
      {% if isNew %}{{ __("blogroll.blogs.create") }}{% else %}{{ __("blogroll.blogs.save") }}{% endif %}
    </button>
    <a href="{{ baseUrl }}/blogs" class="button button--secondary">{{ __("blogroll.cancel") }}</a>
  </div>
</form>

{% if not isNew and items %}
<div class="br-section">
  <h3>{{ __("blogroll.blogs.recentItems") }}</h3>
  {% if items.length > 0 %}
  <ul class="br-items-list">
    {% for item in items %}
    <li class="br-item">
      <div class="br-item-title">
        <a href="{{ item.url }}" target="_blank" rel="noopener">{{ item.title }}</a>
      </div>
      <div class="br-item-meta">
        {{ item.published | date("PPpp") }}
      </div>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="br-empty">{{ __("blogroll.blogs.noItems") }}</p>
  {% endif %}
</div>
{% endif %}

{% if isNew %}
<script>
(function() {
  const discoverBtn = document.getElementById('discoverBtn');
  const discoverUrl = document.getElementById('discoverUrl');
  const discoverResult = document.getElementById('discoverResult');
  const feedUrlInput = document.getElementById('feedUrl');
  const titleInput = document.getElementById('title');
  const siteUrlInput = document.getElementById('siteUrl');

  function showResult(message, isError, isSuccess) {
    discoverResult.style.display = 'block';
    discoverResult.className = 'br-discover-result' +
      (isError ? ' br-discover-result--error' : '') +
      (isSuccess ? ' br-discover-result--success' : '');
    discoverResult.textContent = '';

    const span = document.createElement('span');
    span.textContent = message;
    discoverResult.appendChild(span);
  }

  function showFeedUrl(message, url) {
    discoverResult.style.display = 'block';
    discoverResult.className = 'br-discover-result br-discover-result--success';
    discoverResult.textContent = '';

    const span = document.createElement('span');
    span.textContent = message + ' ';
    discoverResult.appendChild(span);

    const code = document.createElement('code');
    code.textContent = url;
    discoverResult.appendChild(code);
  }

  discoverBtn.addEventListener('click', async function() {
    const url = discoverUrl.value.trim();
    if (!url) {
      showResult('{{ __("blogroll.blogs.form.discoverNoUrl") }}', true, false);
      return;
    }

    discoverBtn.disabled = true;
    discoverBtn.textContent = '{{ __("blogroll.blogs.form.discovering") }}';
    showResult('{{ __("blogroll.blogs.form.discoveringHint") }}', false, false);

    try {
      const response = await fetch('{{ baseUrl }}/api/discover?url=' + encodeURIComponent(url));
      const data = await response.json();

      if (!data.success) {
        showResult(data.error || '{{ __("blogroll.blogs.form.discoverFailed") }}', true, false);
        return;
      }

      if (data.feeds.length === 0) {
        showResult('{{ __("blogroll.blogs.form.discoverNoFeeds") }}', true, false);
        return;
      }

      // Auto-fill siteUrl and title if available
      if (data.siteUrl) {
        siteUrlInput.value = data.siteUrl;
      }
      if (data.pageTitle && !titleInput.value) {
        titleInput.value = data.pageTitle;
      }

      // If only one feed, auto-select it
      if (data.feeds.length === 1) {
        feedUrlInput.value = data.feeds[0].url;
        showFeedUrl('{{ __("blogroll.blogs.form.discoverFoundOne") }}', data.feeds[0].url);
        return;
      }

      // Multiple feeds - let user choose
      showResult('{{ __("blogroll.blogs.form.discoverFoundMultiple") }}', false, true);

      const feedList = document.createElement('ul');
      feedList.className = 'br-discover-feeds';

      data.feeds.forEach(function(feed) {
        const li = document.createElement('li');
        li.className = 'br-discover-feed';

        const typeSpan = document.createElement('span');
        typeSpan.className = 'br-discover-feed-type';
        typeSpan.textContent = feed.type;
        li.appendChild(typeSpan);

        const urlSpan = document.createElement('span');
        urlSpan.className = 'br-discover-feed-url';
        urlSpan.textContent = feed.url;
        li.appendChild(urlSpan);

        li.addEventListener('click', function() {
          feedUrlInput.value = feed.url;
          showFeedUrl('{{ __("blogroll.blogs.form.discoverSelected") }}', feed.url);
        });
        feedList.appendChild(li);
      });

      discoverResult.appendChild(feedList);
    } catch (error) {
      showResult(error.message || '{{ __("blogroll.blogs.form.discoverFailed") }}', true, false);
    } finally {
      discoverBtn.disabled = false;
      discoverBtn.textContent = '{{ __("blogroll.blogs.form.discover") }}';
    }
  });

  // Allow pressing Enter in the URL field
  discoverUrl.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      discoverBtn.click();
    }
  });
})();
</script>
{% endif %}
{% endblock %}
